"use client";
import toast from "react-hot-toast";
import { useState, useLayoutEffect, useRef, useEffect } from "react";
import {
  SkyWayContext,
  SkyWayRoom,
  LocalSFURoomMember,
  SkyWayStreamFactory,
  SfuRoom, //„Åª„Å®„Çì„Å©„Ååts„ÅÆÂûãÊåáÂÆö„ÅÆ„Ç¢„É™„Éê„Ç§Áî®
  RoomPublication,
  LocalStream,
  RemoteRoomMember,
  RemoteVideoStream,
  RemoteAudioStream,
  MemberJoinedEvent,
  MemberLeftEvent,
} from "@skyway-sdk/room";
import { faker } from '@faker-js/faker/locale/ja';
import { useRecoilState } from "recoil";
import {
  skywayTokenState,
  myChannelNameState,
  skywayJwtForTokenState,
} from "@/lib/context";
import { JA_CHANNEL_MAPPINGS } from "@/lib/constant";
import MyVideo from "./myVideo";
import { validSkywayToken } from "@/lib/controlSkyway";
import ControlCardList from "./Card";
// import BasicSetup from "./DraggableCard";
// import ControlDCardList from "./DraggableCard";

type MemberInfo = { memberId: string; memberName: string };

import Image from "next/image";

export default function DynamicComponentRoom() {
  const [skywayToken, setSkywayToken] = useRecoilState(skywayTokenState);
  const [skywayJwtForToken, setSkywayJwtForToken] = useRecoilState(
    skywayJwtForTokenState
  );
  const [myChannelName] = useRecoilState(myChannelNameState);
  const [memberList, setMemberList] = useState<MemberInfo[]>([]);
  const [isChannelJoined, setIsChannelJoined] = useState(false);
  const [isChannelInitializing, setIsChannelInitializing] = useState(false);
  const [myName, setMyName] = useState("");
  const [myId, setMyId] = useState("");
  const myVideoRef = useRef<HTMLCanvasElement>(null);
  const memberListRef = useRef<HTMLDivElement>(null);
  let room: SfuRoom;
  let member: LocalSFURoomMember;

  const [isNavigationAllowed, setIsNavigationAllowed] = useState(false);

  useLayoutEffect(() => {
    setMyName(faker.person.lastName());
    if (!validSkywayToken(skywayJwtForToken)) {
      setSkywayToken("");
      setSkywayJwtForToken("");
      location.href = "/";
    }
  }, []);

  useEffect(() => {
    const handleBeforeUnload = (event: BeforeUnloadEvent) => {
      if (!isNavigationAllowed) {
        const message = 'Êú¨ÂΩì„Å´„Éö„Éº„Ç∏„ÇíÈõ¢„Çå„Åæ„Åô„ÅãÔºü';
        event.returnValue = message;  // „Åì„Çå„ÅåÁ¢∫Ë™ç„ÉÄ„Ç§„Ç¢„É≠„Ç∞„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô„ÄÇ
        return message;
      }
    };

    window.addEventListener('beforeunload', handleBeforeUnload);

    return () => {
      window.removeEventListener('beforeunload', handleBeforeUnload);
    };
  }, [isNavigationAllowed]); // ‰æùÂ≠òÈÖçÂàó„Å´ `isNavigationAllowed` „ÇíËøΩÂä†

  // „Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥„ÇíË®±ÂèØ„Åô„Çã„Åü„ÇÅ„ÅÆ„Éú„Çø„É≥„ÅÆ„Éè„É≥„Éâ„É©
  const allowNavigation = () => {
    setIsNavigationAllowed(true);
  };

  useEffect(() => {
    // Â±•Ê≠¥„Ç®„É≥„Éà„É™„ÇíËøΩÂä†„Åó„Å¶„ÄÅ„Éö„Éº„Ç∏„É≠„Éº„ÉâÊôÇ„ÅÆ‰ΩçÁΩÆ„Å´Âõ∫ÂÆö„Åô„Çã
    window.history.pushState(null, document.title, window.location.href);

    const handlePopState = (event: PopStateEvent): void => {
      // ÂÜçÂ∫¶„ÄÅÁèæÂú®„ÅÆ‰ΩçÁΩÆ„ÅßÂ±•Ê≠¥„Ç®„É≥„Éà„É™„ÇíËøΩÂä†„Åó„ÄÅ„Éê„ÉÉ„ÇØ„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥„ÇíÈò≤„Åê
      window.history.pushState(null, document.title, window.location.href);
    };

    window.addEventListener('popstate', handlePopState);

    return () => {
      window.removeEventListener('popstate', handlePopState);
    };
  }, []);

  const subscribeAndAttach = async (publication: RoomPublication<LocalStream>) => {
    if (!room) {
      return;
    }
    if (publication.publisher.id === member.id) {
      setMyId(member.id);
      return;
    }
    const { stream } = await member.subscribe<RemoteVideoStream | RemoteAudioStream>(publication.id);
    let mediaElement;
    const memberDiv = memberListRef.current
      ?.getElementsByClassName(`member-${publication.publisher.id}`)
      .item(0) as HTMLDivElement;
    switch (stream.contentType) {
      case "video":
        mediaElement = memberDiv
          .getElementsByTagName("video")
          .item(0) as HTMLVideoElement;
        break;
      case "audio":
        mediaElement = memberDiv
          .getElementsByTagName("audio")
          .item(0) as HTMLAudioElement;
        break;
      default:
        return;
    }
    stream.attach(mediaElement);
  }

  const testShowInfo = () => {
    console.log("Checking info from Skyway SDK----------------------------");
    console.log(room);
    console.log(room.members);
    console.log("----------------------------");
  }

  const startMemberListControl = () => {
    //Âçò„Å™„ÇãÈÄöÁü•„Å†„Åë„Åß„Å™„ÅèÔºåmemberDiv„Å´„ÇÇÈñ¢‰øÇ„Åó„Å¶„ÅÑ„Çã
    if (!room) {
      return;
    }

    room.members.forEach((remoteMember: RemoteRoomMember) => {
      if (remoteMember.id == member.id) {
        return;
      }
      setMemberList((prev) => [
        ...prev,
        { memberId: remoteMember.id, memberName: remoteMember.metadata || "" },
      ]);
    });

    room.onMemberJoined.add(async (event: MemberJoinedEvent) => {
      setMemberList((prev) => [
        ...prev,
        { memberId: event.member.id, memberName: event.member.metadata || "" },
      ]);
      toast(`${event.member.metadata}„Åï„Çì„ÅåÂèÇÂä†„Åó„Åæ„Åó„Åü`, { icon: "üëè" });
      console.log(member.id);
    });

    room.onMemberLeft.add(async (event: MemberLeftEvent) => {
      setMemberList((prev) =>
        prev.filter((member) => member.memberId !== event.member.id)
      );
      toast(`${event.member.metadata}„Åï„Çì„ÅåÈÄÄÂá∫„Åó„Åæ„Åó„Åü`, { icon: "üí®" });
    });
  }

  const publishVideoAndAudioStream = async () => {
    const { audio, video } = await SkyWayStreamFactory.createMicrophoneAudioAndCameraStream({
      video: { height: 200, width: 300, frameRate: 15 },
    });
    await member.publish(video, {
      encodings: [
        // Ë§áÊï∞„ÅÆ„Éë„É©„É°„Éº„Çø„Çí„Çª„ÉÉ„Éà„Åô„Çã
        { maxBitrate: 400_000, scaleResolutionDownBy: 2 },
        { maxBitrate: 680_000, scaleResolutionDownBy: 1 },
      ],
    });
    await member.publish(audio);
  }

  const joinChannel = async () => {
    if (!Object.keys(JA_CHANNEL_MAPPINGS).includes(myChannelName)) {
      return toast.error("‰∏çÊ≠£„ÉÅ„É£„É≥„Éç„É´Âêç„Åß„Åô");
    }
    if (!skywayToken) {
      return toast.error("skyway„ÇíÂà©Áî®„Åô„ÇãToken„Åå„ÅÇ„Çä„Åæ„Åõ„Çì");
    }
    if (isChannelInitializing) {
      return toast.error("ÁèæÂú®„ÉÅ„É£„É≥„Éç„É´ÂàùÊúüÂåñ‰∏≠„Åß„Åô\n„Åì„ÅÆ„Åæ„Åæ„ÅäÂæÖ„Å°‰∏ã„Åï„ÅÑ");
    }

    setIsChannelInitializing(() => true);

    try {
      //‰ªªÊÑè„ÅÆRoom„ÅÆÂèñÂæó„ÇíË©¶„Åø„Å¶Ôºå„Å™„Åë„Çå„Å∞‰ΩúÊàê
      const context = await SkyWayContext.Create(skywayToken);
      //room„ÅØconst„Åß„ÅØ„Å™„ÅÑ„Åß„ÅôÔºÅÔºÅÔºÅÔºÅÔºÅ
      room = await SkyWayRoom.FindOrCreate(context, {
        type: "sfu",
        name: JA_CHANNEL_MAPPINGS[myChannelName],
      });
      // Member„ÅÆRoom„Å∏„ÅÆÂèÇÂä†
      member = await room.join({
        metadata: myName,
      });
      setIsChannelJoined(() => true);

      testShowInfo();

      startMemberListControl();
      await publishVideoAndAudioStream();
      room.publications.forEach(subscribeAndAttach);
      room.onStreamPublished.add((e) => subscribeAndAttach(e.publication));
      toast.success(
        `Êé•Á∂öÊàêÂäü`
      );
      // console.log(member.id);
    } catch (e) {
      console.error(e);
      initializeToken("„ÉÅ„É£„É≥„Éç„É´ÂàùÊúüÂåñÊôÇ„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ\n5ÁßíÂæå„Å´ÂÜÖÈÉ®„Éà„Éº„ÇØ„É≥„ÇíÂàùÊúüÂåñ„Åó„Å¶„Éà„ÉÉ„Éó„Éö„Éº„Ç∏„Å∏ÈÅ∑Áßª„Åó„Åæ„Åô„ÄÇ");
    }
    setIsChannelInitializing(() => false);
  };

  function initializeToken(message: string) {
    toast.error(
      message
    );
    setTimeout(() => {
      setSkywayToken("");
      setSkywayJwtForToken("");
      location.href = "/";
    }, 5000);
  }

  const randomDealCard = async () => {
    console.log("Checking info from Skyway SDK----------------------------");

    // console.log(room); //ÁÑ°ÁêÜÔºéjoinChannelÂÜÖ„ÅÆÈñ¢Êï∞„Åß„Åó„Åãroom„ÅØÂèñÂæó„Åß„Åç„Å™„ÅÑ

    console.log("----------------------------");

    // console.log(memberList);
    // const data = {
    //   myChannelName: myChannelName,
    //   myName: myName,
    //   myId: myId,
    //   memberList: memberList,
    // };

    // const response = await fetch("/api/getCardInfo", {
    //   method: "POST",
    //   headers: {
    //     "Content-Type": "application/json",
    //   },
    //   body: JSON.stringify(data),
    // });

    // const apiResponse = await response.json();

    // if (response.ok) {
    //   if (apiResponse.isSuccess) {
    //     const apiResponseBody = apiResponse.body;
    //     console.log(apiResponseBody);
    //   } else {
    //     const apiResponseBody = apiResponse.body;
    //     toast.error(apiResponseBody.errorMessage);
    //   }
    // } else {
    //   toast.error("connectionError");
    //   console.error(response)
    // }

  };

  return (
    <>
      <div>
        <div
          ref={memberListRef}
          className="grid grid-cols-5 md:grid-cols-5 border bg-black border-black"
        >
          <div className="border-2 border-gray-800">
            <p className="text-center py-2 text-lx font-bold text-white">„ÅÇ„Å™„Åü({myName})</p>
            <MyVideo ref={myVideoRef} myName={myName} />
          </div>
          {memberList &&
            memberList.map((member) => {
              return (
                <div
                  key={member.memberId}
                  className={`border-2 border-gray-800 member-${member.memberId}`}
                >
                  <p className="text-center py-2 text-lx font-bold text-white">{member.memberName}</p>
                  <video autoPlay playsInline muted src="" className="w-full aspect-w-16 aspect-h-9" />
                  <audio autoPlay src="" />
                </div>
              );
            })}
        </div>
        <div className="flex flex-col text-center w-full mb-1">
          {(true || isChannelJoined) && (
            (true || memberList.length) ? ( //„Éá„Éê„ÉÉ„Ç∞Áî®„Å´true„ÇíÂÖ•„Çå„Å¶„ÅÑ„Çã
              // isChannelJoined„Ååtrue„Åß„ÄÅ„Åã„Å§memberList„Å´„É°„É≥„Éê„Éº„ÅåÂ≠òÂú®„Åô„ÇãÂ†¥Âêà„ÅÆ„Ç≥„É≥„ÉÜ„É≥„ÉÑ
              <div>
                <div>
                  <ControlCardList />
                  {/* <ControlDCardList /> */}
                  <h1 className="text-2xl font-medium title-font text-gray-900">
                    ÂèÇÂä†„ÉÅ„É£„É≥„Éç„É´Ôºö{myChannelName}
                  </h1>
                  <>
                    <p className="text-gray-700 opacity-60">ÈÉ®Â±ãÈÄÄÂá∫„ÅØ„Äå„Éà„ÉÉ„Éó„Éö„Éº„Ç∏„Å´Êàª„Çã„Äç„Éú„Çø„É≥„Åã„Çâ</p>
                  </>
                </div>
              </div>
            ) : (
              // isChannelJoined„Ååtrue„Åß„ÄÅ„Åã„Å§memberList„Å´„É°„É≥„Éê„Éº„ÅåÂ≠òÂú®„Åó„Å™„ÅÑÂ†¥Âêà„ÅÆ„Ç≥„É≥„ÉÜ„É≥„ÉÑ
              <div className="flex flex-wrap flex-columns justify-center mt-2">
                <div className="bg-gray-100 rounded flex p-4 h-full items-center">
                  <div className="animate-spin h-10 w-10 mr-2 border-4 border-blue-700 rounded-full border-t-transparent"></div>
                  <span className="title-font font-medium">
                    ‰ªñ„ÅÆ‰∫∫„ÅåÂèÇÂä†„Åô„Çã„ÅÆ„ÇíÂæÖ„Å£„Å¶„ÅÑ„Åæ„Åô...
                  </span>
                </div>
              </div>
            )
          )}
        </div>
        {!isChannelJoined && (
          <div className="p-2">
            <button
              onClick={joinChannel}
              className="flex mx-auto bg-green-500 border-0 px-8 focus:outline-none hover:bg-green-600 rounded disabled:bg-gray-600"
            >
              {(true) ? (
                <p className="text-white text-lg p-2">
                  „ÉÅ„É£„É≥„Éç„É´„Å´ÂèÇÂä†„Åô„Çã
                  <span className="block mt-1 text-sm pl-1 pb-2 text-white/80">
                    ‚ÄªÊò†ÂÉè&Èü≥Â£∞„ÅÆÈÄÅÂèó‰ø°ÈñãÂßã
                  </span>
                </p>
              ) :
                <span className="text-white text-lg p-2 inline-block align-middle">
                  „Ç´„É°„É©„Å®Èü≥Â£∞„ÅåÊúâÂäπ„Å´„Å™„Çã„Å®„ÉÅ„É£„É≥„Éç„É´ÂèÇÂä†„Åß„Åç„Åæ„Åô
                </span>
              }
            </button>
          </div>
        )}
      </div>

      <div>
        <section className="fixed right-0 bottom-0 flex m-2">
          <a href="/" onClick={allowNavigation}>
            <div className="text-4lx bg-red-600 rounded-lg p-4 mb-2 text-center hover:bg-red-700 cursor-pointer text-white font-bold mr-2">
              „Éà„ÉÉ„Éó„Éö„Éº„Ç∏„Å´Êàª„Çã
            </div>
          </a>
          <button
            onClick={() => {
              initializeToken("5ÁßíÂæå„Å´„Éà„Éº„ÇØ„É≥„ÇíÂàùÊúüÂåñ„Åó„Åæ„Åô.");
              allowNavigation();
            }}
            className="text-4lx bg-red-600 rounded-lg p-4 mb-2 text-center hover:bg-red-700 cursor-pointer text-white font-bold mr-2"
          >
            „Éà„Éº„ÇØ„É≥„ÇíÂàùÊúüÂåñ
          </button>
          
          <button
            onClick={randomDealCard}
            className="text-4lx bg-red-600 rounded-lg p-4 mb-2 text-center hover:bg-red-700 cursor-pointer text-white font-bold mr-2"
          >
            „É©„É≥„ÉÄ„É†ÈÖçÂ∏É
          </button>
        </section>
      </div>

    </>
  );
}